# java-convenience-store-precourse
## 흐름

```
      ┌──────────────── 시작
      │                  │
      │         ┌────────┴─────────┐
      │         │    상품 목록 출력   │
      │         └────────┬─────────┘
      │                  │
      │         ┌────────┴─────────┐
      │         │ 상품명, 수량 입력    │
      │         └────────┬─────────┘
      │                  │
      │     ┌────────────┴──────────┐
      │     │     프로모션 포함 여부    │
      │     └───────────────────────┘
      │                  │
      │                 Yes
      │                  │
      │     ┌────────────┴───────────────────┐
      │     │      증정 수량 보유 여부           │
      │     └─┬──────────────────┬───────────┘
      │       Y                  │                   
      │       e                  No                 
      │       s                  │     
      │       │       ┌──────────┴───────────────────┐
      │       │──Yes──│    정가로 구매할 것인가?          │
      │       │       └──────────────────────────────┘     
      │       │                   │No 
      │       │       ┌───────────┴───────────────┐    
      │       │───────│ 프로모션 못 받을 항목 제거      │
      │       │       └───────────────────────────┘   
      │       │                  
      │       │                  
      │       │                  
      │       │       ┌──────────────────────────┐   
      │       │       │       멤버십 여부           │─────No───┐   
      │       └───────└───────────┬──────────────┤          │
      │                           │                         │
      │                          Yes                        │
      │                           │                         │
      │                           │                         │
      │                 ┌──────────────────────┐            │
      │                 │   멤버십 할인 계산       │            │
      │                 └──────────────────────┘            │
      │                           │                         │
      │                    ┌──────┴───────┐                 │
      │                    │ 구매 목록 출력  │                 │
      │                    └──────┬───────┘                 │
      │                           │                         │
      │                    ┌──────┴───────┐                 │
      └─────────────N o────│   추가 여부    │─────────────────┘
                           └──────┬───────┘
                                  │Y e s
                                 종료
```
## 기능 요구 사항
### 입력
- 상품명, 개수를 입력받는다.
- 멤버쉽 할인 여부를 입력받는다.
- 프로모션 개수가 부족할 경우, 정가로 구매할지 여부를 입력받는다.
- 프로모션보다 덜 가져왔을 경우, 상품을 추가할지 여부를 입력받는다.
- 구매 로직이 끝난 후, 새로운 주문을 할지 여부를 입력받는다.

### 출력
- 판매 상품 목록을 출력한다.
- 영수증 내역을 출력한다.

### 도메인
1. Product 클래스 생성
   - products.md에 있는 `name`,`price`,`quantity`,`promotion` 필드를 갖는다.
   - `promotion`의 경우, promotion 이름을 입력 받아 이름이 같은 Promotion을 찾아 해당 Promotion을 주입하도록 한다.
   - 재고 현황 출력을 위한 toString을 작성한다.
   - 구매 수량에 대한 유효성 검사를 가진다.
2. Promotion 클래스 생성
   - promotions.md에 있는 `name`, `buy`, `get`, `start_date`, `end_date` 필드를 갖는다.
   - 현재 시간과 비교하여 유효한 프로모션인지 검사하는 메서드를 갖는다. 
3. Store 클래스 생성
   - 상품 목록과 프로모션 목록을 가진다.
   - reader를 통해 md파일로 부터 상품과 프로모션을 생성하여 목록에 추가한다.
   - 이름을 통해 상품과 프로모션을 찾는 메서드를 가진다.
4. CartItem 클래스 생성
   - `product`, `프로모션 적용 공짜 개수(freeItem)`, `프로모션 적용 구매 개수(paidItem)`, `일반 구매 개수(remainItem)` 필드를 갖는다.
   - 구매 물품의 총 개수와 총 금액을 반환하는 메서드를 가진다.
5. Cart 클래스 생성
   - List<CartItem> 를 가진다.
   - CartItem들에 대한 프로모션 적용 공짜 아이템, 프로모션 적용 구매 아이템, 일반 구매 아이템들을 반환하는 메서드를 가진다.
6. Payment(결제 내역을 가지는) 클래스 생성
   - `프로모션 적용 공짜 금액`, `프로모션 적용 구매 금액`, `일반 구매 금액`, `멤버십 여부`를 필드로 갖는다.
   - 멤버십 할인 금액을 구하는 메서드를 갖는다.
     - min(8000원, 일반 구매 금액 * 0.3);
7. md 파일 reader 생성
   - promotions.md와 products.md을 읽어 DTO를 생성한다.
     - DTO는 모든 값을 String으로 저장한다. 이후, 객체로 변환 시, 정적 팩토리 메서드를 이용한다.

### 서비스

1. 장바구니에 아이템을 추가한다.
   - CartItem으로 Product를 변환한다.
   - CartItem으로 변환 시, 프로모션 상품 - 일반 상품 순으로 차감한다.
   - 만약 차감 시 PromotionStuckException 발생 시, 정가 구매 여부를 물어본다.
   - 만약 차감 시 RegularStuckException 발생 시, 돈이 부족하다고 하고 상품명 입력으로 돌아간다.
2. 할인 금액을 계산
    - 맴버십 할인 적용된 경우
      - 프로모션 미적용 금액의 30%를 할인받는다.
      - 프로모션 적용 후 남은 금액에 대해 멤버십 할인을 적용한다.
      - 멤버십 할인의 최대 한도는 8,000원이다.
   - 결제 목록 추산
     - 맴버십 할인 액 = min(8000, (결제 금액 * 0.3))
     - 총 결제 액 = 결제 금액 - 멤버십 할인 액
3. `프로모션 적용 공짜 개수(freeItem)`, `프로모션 적용 구매 개수(paidItem)`, `일반 구매 개수(remainItem)`를 구한다.
   (* 사용자 구매 개수를 quantity라고 가정)
   - 프로모션 재고가 0이거나 프로모션 기간이 지났을 경우, {0,0,quantity}로 계산
   - 프로모션 재고가 1이상인 경우
     - 프로모션을 적용하여 받을 수 있는 최고 쌍(maxPromo)를 구한다. (freeItem, paidItem)
     - 프로모션 적용 개수보다 적은 개수를 가져온 경우(maxPromo = 0인 경우) 에는 추가 여부를 물어보고, getCount만큼 추가한다.
     - 프로모션 재고가 부족한 경우, 적용되지 않는 개수에 대한 정가 구매 여부를 물어보고 개수를 수정한다.

### 예외 처리
- 입력한 개수가 음수이거나 재고 개수보다 많은 경우, 재고 부족 에러 표시 후 다시 입력한다.
- 존재하지 않는 상품명, 정수가 아닌 개수가 입력된 경우, 잘못된 입력 에러 표시 후 다시 입력하도록 한다.
- Y/N을 입력받는 선택지에서 다른 형식이 입력된 경우, 해당 입력을 다시 받는다.